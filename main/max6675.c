/**
 * @file max6675.c
 * @author
 * @date
 * @brief
 */

//=============================================================================
// [Inclusions] ===============================================================
#include <driver/spi_master.h>
#include <driver/gpio.h>
#include "esp_log.h"

#include "max6675.h"

//=============================================================================

//=============================================================================
// [Private Defines] ==========================================================
#define MAX6675_DMA_CHAN        2

#define MAX6675_GPIO_MISO       GPIO_NUM_2
#define MAX6675_GPIO_CLK        GPIO_NUM_15
#define MAX6675_GPIO_CS         GPIO_NUM_4

//=============================================================================

//=============================================================================
// [Local Typedef] ============================================================

//=============================================================================

//=============================================================================
// [External Data Definitions] ================================================

// Const ---------------------------------------------
//----------------------------------------------------

// Vars ----------------------------------------------
//----------------------------------------------------

// Task Handlers -------------------------------------
//----------------------------------------------------

// Queue Handlers ------------------------------------
//----------------------------------------------------

// Event Group Handlers ------------------------------
//----------------------------------------------------

// Semaphore Handlers --------------------------------
//----------------------------------------------------

//=============================================================================

//=============================================================================
// [Local Data Declarations] ==================================================

// Const ---------------------------------------------
//----------------------------------------------------

// Vars ----------------------------------------------
static spi_device_handle_t max6675_spi_handle = NULL;

//----------------------------------------------------

// Task Handlers -------------------------------------
//----------------------------------------------------

// Queue Handlers ------------------------------------
//----------------------------------------------------

// Event Group Handlers ------------------------------
//----------------------------------------------------

// Semaphore Handlers --------------------------------
//----------------------------------------------------

//=============================================================================

//=============================================================================
// [Local Function Declarations] ==============================================

//=============================================================================

//=============================================================================
// [FreeRTOS Task Definitions] ================================================

//=============================================================================

//=============================================================================
// [Local Function Definitions] ===============================================

//=============================================================================

//=============================================================================
// [External Function Definition] =============================================

void max6675_init(void)
{
    spi_bus_config_t bus_cfg = {
            .miso_io_num = MAX6675_GPIO_MISO,
            .mosi_io_num = -1,
            .sclk_io_num = MAX6675_GPIO_CLK,
            .quadwp_io_num = -1,
            .quadhd_io_num = -1,
            .max_transfer_sz = (4 * 8)
    };

    /* Initialize the SPI bus */
    spi_bus_initialize(VSPI_HOST, &bus_cfg, MAX6675_DMA_CHAN);


    spi_device_interface_config_t dev_cfg = {
            .mode = 0,
            .clock_speed_hz = 100000,
            .spics_io_num = MAX6675_GPIO_CS,
            .queue_size = 3
    };

    spi_bus_add_device(VSPI_HOST, &dev_cfg, &max6675_spi_handle);
}
// End void max6675_init(void)


bool max6675_read(float_t * temperature)
{
    bool ret_val = true;
    uint16_t data = 0;

    spi_transaction_t trans = {
            .tx_buffer = NULL,
            .rx_buffer = &data,
            .length = 16,
            .rxlength = 16
    };

    spi_device_acquire_bus(max6675_spi_handle, portMAX_DELAY);
    spi_device_transmit(max6675_spi_handle, &trans);
    spi_device_release_bus(max6675_spi_handle);

    data = SPI_SWAP_DATA_RX(data, 16);

    *temperature = (data >> 3) / 4.0;

    if (true == ((data >> 2) & 1))
    {
        ret_val = false;
    }

    return ret_val;
}
// End bool max6675_read(float_t * temperature)

//=============================================================================

//====================== [End Document] =======================================
